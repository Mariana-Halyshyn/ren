import SwiftUI

struct WeatherDetailView: View {
    @ObservedObject var viewModel: WeatherViewModel
    @ObservedObject var favoritesVM: FavoritesViewModel
    
    @State private var cityInput = ""
    @State private var showMenu = false
    
    var body: some View {
        ZStack {
            Color(red: 0.93, green: 0.95, blue: 1.0)
                .ignoresSafeArea()
            
            VStack(alignment: .leading, spacing: 16) {
                
                // MARK: - Top bar
                HStack {
                    Button {
                        showMenu.toggle()
                    } label: {
                        Image(systemName: "line.3.horizontal")
                            .font(.title2)
                    }
                    
                    Spacer()
                    
                    Text(viewModel.currentWeather?.name ?? "–ü–æ–≥–æ–¥–∞")
                        .font(.headline)
                    
                    Spacer()
                }
                .padding(.horizontal)
                
                // MARK: - Search
                HStack {
                    TextField("–í–≤–µ–¥—ñ—Ç—å –º—ñ—Å—Ç–æ", text: $cityInput)
                        .padding(10)
                        .background(Color.white)
                        .cornerRadius(8)
                    
                    Button("–ü–æ—à—É–∫") {
                        viewModel.fetchWeather(city: cityInput, lat: nil, lon: nil)
                        cityInput = ""
                        UIApplication.shared.endEditing()
                    }
                    .padding(.horizontal)
                    .padding(.vertical, 10)
                    .background(Color.yellow)
                    .cornerRadius(8)
                }
                .padding(.horizontal)
                
                // MARK: - Current weather (TEXT LEFT, ICON RIGHT)
                if let weather = viewModel.currentWeather {
                    HStack {
                        VStack(alignment: .leading, spacing: 6) {
                            Text("\(Int(weather.main.temp))¬∞")
                                .font(.system(size: 60, weight: .bold))
                            
                            Text(weather.weather.first?.description.capitalized ?? "")
                                .font(.title3)
                            
                            Text("üìç \(weather.name)")
                                .foregroundColor(.gray)
                        }
                        
                        Spacer()
                        
                        Image(systemName: weather.weather.first?.iconNameSF ?? "cloud")
                            .font(.system(size: 60))
                    }
                    .padding(.horizontal)
                }
                
                // MARK: - Hourly forecast
                Text("–ü–æ–≥–æ–¥–∏–Ω–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑")
                    .font(.headline)
                    .padding(.horizontal)
                
                ScrollView(.horizontal, showsIndicators: false) {
                    HStack(spacing: 12) {
                        ForEach(viewModel.forecastItems, id: \.dt) { item in
                            VStack(spacing: 6) {
                                Text(hourString(from: item.date))
                                    .font(.caption)
                                
                                Image(systemName: item.weatherIconName)
                                
                                Text("\(Int(item.main.temp))¬∞")
                            }
                            .padding(10)
                            .background(Color.white)
                            .cornerRadius(10)
                        }
                    }
                    .padding(.horizontal)
                }
                
                // MARK: - Weather explanation (TEXT ONLY)
                if let main = viewModel.currentWeather?.weather.first?.main {
                    Text(weatherAdvice(for: main))
                        .padding()
                        .background(Color.white)
                        .cornerRadius(12)
                        .padding(.horizontal)
                }
                
                // MARK: - 5 day forecast (without today)
                Text("5-–¥–µ–Ω–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑")
                    .font(.headline)
                    .padding(.horizontal)
                
                VStack(spacing: 8) {
                    ForEach(viewModel.dailyForecast.dropFirst(), id: \.dt) { item in
                        HStack {
                            Text(item.dayOfWeekShort)
                            Spacer()
                            Image(systemName: item.weatherIconName)
                            Text("\(Int(item.main.temp))¬∞")
                        }
                        .padding()
                        .background(Color.white)
                        .cornerRadius(8)
                    }
                }
                .padding(.horizontal)
                
                Spacer()
            }
        }
        .onAppear {
            viewModel.requestUserLocation()
        }
    }
    
    // MARK: - Helpers
    
    private func hourString(from date: Date) -> String {
        let f = DateFormatter()
        f.dateFormat = "HH:mm"
        return f.string(from: date)
    }
    
    // ‚ùó –ë–ï–ó "–•–º–∞—Ä–Ω–æ:", "–°–æ–Ω—è—á–Ω–æ:"
    private func weatherAdvice(for condition: String) -> String {
        switch condition.lowercased() {
        case "clear":
            return "–°—å–æ–≥–æ–¥–Ω—ñ —Å–æ–Ω—è—á–Ω–æ —Ç–∞ —Ç–µ–ø–ª–æ ‚Äî —ñ–¥–µ–∞–ª—å–Ω–∏–π –¥–µ–Ω—å –¥–ª—è –ø—Ä–æ–≥—É–ª—è–Ω–æ–∫."
        case "clouds":
            return "–ù–∞ –Ω–µ–±—ñ —Ö–º–∞—Ä–∏, –∞–ª–µ –±–µ–∑ –æ–ø–∞–¥—ñ–≤ ‚Äî –ø–æ–≥–æ–¥–∞ —Å–ø–æ–∫—ñ–π–Ω–∞."
        case "rain":
            return "–°—å–æ–≥–æ–¥–Ω—ñ –¥–æ—â–∏—Ç–∏–º–µ, –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–∏—Ö–æ–ø–∏—Ç–∏ –ø–∞—Ä–∞—Å–æ–ª—å–∫—É."
        case "thunderstorm":
            return "–ú–æ–∂–ª–∏–≤–∞ –≥—Ä–æ–∑–∞ ‚Äî –±—É–¥—å—Ç–µ –æ–±–µ—Ä–µ–∂–Ω—ñ —Ç–∞ —É–Ω–∏–∫–∞–π—Ç–µ –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö –ø—Ä–æ—Å—Ç–æ—Ä—ñ–≤."
        case "snow":
            return "–°–Ω—ñ–∂–∏—Ç–∏–º–µ, –Ω–∞ –¥–æ—Ä–æ–≥–∞—Ö —Å–ª–∏–∑—å–∫–æ."
        case "fog", "mist":
            return "–í—Ä–∞–Ω—Ü—ñ –º–æ–∂–ª–∏–≤–∏–π —Ç—É–º–∞–Ω ‚Äî –≤–æ–¥—ñ—è–º –≤–∞—Ä—Ç–æ –±—É—Ç–∏ —É–≤–∞–∂–Ω–∏–º–∏."
        case "wind":
            return "–°—å–æ–≥–æ–¥–Ω—ñ –≤—ñ—Ç—Ä—è–Ω–æ, –æ–¥—è–≥–∞–π—Ç–µ—Å—è —Ç–µ–ø–ª—ñ—à–µ."
        case "heat":
            return "–°–ø–µ–∫–æ—Ç–Ω–æ, –ø–∏–π—Ç–µ –±—ñ–ª—å—à–µ –≤–æ–¥–∏ —Ç–∞ —É–Ω–∏–∫–∞–π—Ç–µ —Å–æ–Ω—Ü—è."
        default:
            return "–ü–æ–≥–æ–¥–Ω—ñ —É–º–æ–≤–∏ —Å–ø–æ–∫—ñ–π–Ω—ñ, –º–æ–∂–Ω–∞ –ø–ª–∞–Ω—É–≤–∞—Ç–∏ —Å–ø—Ä–∞–≤–∏ –Ω–∞ –¥–µ–Ω—å."
        }
    }
}
