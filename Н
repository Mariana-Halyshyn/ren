import Foundation
import SwiftUI
import Combine

final class FavoritesViewModel: ObservableObject {
    @Published private(set) var favoriteCities: [String] = []
    private let storageKey = "favorites.cities.v1"
    
    init() { load() }
    
    var shouldShowEditButton: Bool { !favoriteCities.isEmpty }
    
    func addCity(_ city: String) {
        let normalized = city.trimmingCharacters(in: .whitespacesAndNewlines)
        guard !normalized.isEmpty else { return }
        if !favoriteCities.contains(where: { $0.caseInsensitiveCompare(normalized) == .orderedSame }) {
            favoriteCities.append(normalized)
            persist()
        }
    }
    
    /// Видаляє елементи за IndexSet (наприклад: IndexSet(integer: index) або за swipe-to-delete)
    func removeCity(at offsets: IndexSet) {
        favoriteCities.remove(atOffsets: offsets)
        persist()
    }
    
    // Якщо вам потрібно видаляти по індексу (Int), використайте цей хелпер:
    func removeCity(atIndex index: Int) {
        guard favoriteCities.indices.contains(index) else { return }
        favoriteCities.remove(at: index)
        persist()
    }
    
    private func persist() {
        UserDefaults.standard.set(favoriteCities, forKey: storageKey)
        UserDefaults.standard.synchronize()
    }
    
    private func load() {
        if let saved = UserDefaults.standard.stringArray(forKey: storageKey) {
            favoriteCities = saved
        }
    }
}
